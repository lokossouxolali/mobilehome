{% extends "base.html" %}
{% load static %}

{% block content %}
{% if messages %}
    <div class="messages">
        {% for message in messages %}
            <div class="message">{{ message }}</div>
        {% endfor %}
    </div>

    <script>
        setTimeout(function() {
            document.querySelector('.messages').style.display = 'none';
        }, 15000); // 15 secondes
    </script>
{% endif %}
<br><br>

<!-- Filtres de recherche -->
<div class="form-row">
    <div class="col-md-3">
        <input id="search_article" class="form-control" type="text" placeholder="Rechercher par article">
    </div>
    <div class="col-md-3">
        <input id="search_date" class="form-control" type="date">
    </div>
    <div class="col-md-3">
        <input id="search_price" class="form-control" type="number" step="0.01" placeholder="Rechercher par prix">
    </div>
    <div class="col-md-3">
        <select id="search_period" class="form-control">
            <option value="">Sélectionner période</option>
            <option value="day">Aujourd'hui</option>
            <option value="week">Cette semaine</option>
            <option value="month">Ce mois-ci</option>
            <option value="year">Cette année</option>
        </select>
    </div>
</div>

<br>

<div>
    <table class="table table-striped-columns">
        <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">ARTICLE</th>
                <th scope="col">QUANTITE VENDUE</th>
                <th scope="col">DATE DE VENTE</th>
                <th scope="col">CLIENT</th>
                <th scope="col">PRIX UNITAIRE</th>
                <th scope="col">PRIX TOTAL</th>
            </tr>
        </thead>
        <tbody id="myTable">
            {% if sales_data %}
            {% for sale in sales_data %}
            <tr>
                <th scope="row">{{ forloop.counter }}</th>  
                <td class="article">{{ sale.article_name }}</td>
                <td class="quantity">{{ sale.quantity_sold }}</td>
                <td class="date" data-date="{{ sale.sale_date }}">{{ sale.sale_date }}</td>
                <td class="customer">{{ sale.customer_name }}</td>
                <td class="unit_price">{{ sale.unit_price }}</td>
                <td class="total_price">{{ sale.total_price }}</td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
                <td colspan="7" class="text-center">Aucune vente trouvée.</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    var searchArticle = document.getElementById("search_article");
    var searchDate = document.getElementById("search_date");
    var searchPrice = document.getElementById("search_price");
    var searchPeriod = document.getElementById("search_period");
    var tableBody = document.getElementById("myTable");
    var tableRows = tableBody.querySelectorAll("tr");

    // Création d'un message "Aucune vente trouvée"
    var noResultsRow = document.createElement("tr");
    noResultsRow.innerHTML = `<td colspan="7" class="text-center text-danger">Aucune vente trouvée.</td>`;
    noResultsRow.style.display = "none";
    tableBody.appendChild(noResultsRow);

    function filterTable() {
        var articleValue = searchArticle.value.toLowerCase().trim();
        var dateValue = searchDate.value;
        var priceValue = searchPrice.value.trim();
        var periodValue = searchPeriod.value;
        var now = new Date();
        var visibleRows = 0;

        tableRows.forEach(function (row) {
            var articleText = row.querySelector(".article")?.textContent.toLowerCase() || "";
            var dateText = row.querySelector(".date")?.getAttribute("data-date") || "";
            var priceText = row.querySelector(".unit_price")?.textContent.trim() || "";
            var saleDate = new Date(dateText);

            var matchArticle = articleText.includes(articleValue);
            var matchDate = dateValue ? dateText === dateValue : true;
            var matchPrice = priceValue ? parseFloat(priceText) == parseFloat(priceValue) : true;
            var matchPeriod = true;

            if (periodValue === "day") {
                matchPeriod = saleDate.toDateString() === now.toDateString();
            } else if (periodValue === "week") {
                var startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay());
                var endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                matchPeriod = saleDate >= startOfWeek && saleDate <= endOfWeek;
            } else if (periodValue === "month") {
                matchPeriod = saleDate.getMonth() === now.getMonth() && saleDate.getFullYear() === now.getFullYear();
            } else if (periodValue === "year") {
                matchPeriod = saleDate.getFullYear() === now.getFullYear();
            }

            // Afficher ou masquer la ligne selon les filtres
            if (matchArticle && matchDate && matchPrice && matchPeriod) {
                row.style.display = "";
                visibleRows++;
            } else {
                row.style.display = "none";
            }
        });

        // Affichage du message "Aucune vente trouvée" si aucun résultat
        noResultsRow.style.display = visibleRows === 0 ? "" : "none";
    }

    // Écouteurs d'événements pour filtrer en temps réel
    searchArticle.addEventListener("input", filterTable);
    searchDate.addEventListener("change", filterTable);
    searchPrice.addEventListener("input", filterTable);
    searchPeriod.addEventListener("change", filterTable);
});

</script>

{% endblock %}
